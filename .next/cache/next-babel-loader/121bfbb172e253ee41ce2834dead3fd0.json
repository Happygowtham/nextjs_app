{"ast":null,"code":"const MongoClient = require('mongodb').MongoClient;\n\nconst assert = require('assert');\n\nconst bcrypt = require('bcrypt');\n\nconst v4 = require('uuid').v4;\n\nconst jwt = require('jsonwebtoken');\n\nconst jwtSecret = 'SUPERSECRETE20220';\nconst saltRounds = 10;\nconst url = process.env.url;\nconst dbName = process.env.dbName;\nconst client = new MongoClient(url, {\n  useNewUrlParser: true,\n  useUnifiedTopology: true\n});\n\nfunction findUser(db, email, callback) {\n  const collection = db.collection(process.env.dbcollection);\n  collection.findOne({\n    email\n  }, callback);\n}\n\nfunction createUser(db, email, password, callback) {\n  const collection = db.collection(process.env.dbcollection);\n  bcrypt.hash(password, saltRounds, function (err, hash) {\n    // Store hash in your password DB.\n    collection.insertOne({\n      userId: v4(),\n      email,\n      password: hash\n    }, function (err, userCreated) {\n      assert.equal(err, null);\n      callback(userCreated);\n    });\n  });\n}\n\nexport default ((req, res) => {\n  if (req.method === 'POST') {\n    // signup\n    try {\n      assert.notEqual(null, req.body.email, 'Email required');\n      assert.notEqual(null, req.body.password, 'Password required');\n    } catch (bodyError) {\n      res.status(403).json({\n        error: true,\n        message: bodyError.message\n      });\n    } // verify email does not exist already\n\n\n    client.connect(function (err) {\n      assert.equal(null, err);\n      console.log('Connected to MongoDB server =>');\n      const db = client.db(dbName);\n      const email = req.body.email;\n      const password = req.body.password;\n      findUser(db, email, function (err, user) {\n        if (err) {\n          res.status(500).json({\n            error: true,\n            message: 'Error finding User'\n          });\n          return;\n        }\n\n        if (!user) {\n          // proceed to Create\n          createUser(db, email, password, function (creationResult) {\n            if (creationResult.ops.length === 1) {\n              const user = creationResult.ops[0];\n              const token = jwt.sign({\n                userId: user.userId,\n                email: user.email\n              }, jwtSecret, {\n                expiresIn: 3000 //50 minutes\n\n              });\n              res.status(200).json({\n                token\n              });\n              return;\n            }\n          });\n        } else {\n          // User exists\n          res.status(403).json({\n            error: true,\n            message: 'Email exists'\n          });\n          return;\n        }\n      });\n    });\n  } else {\n    // Handle any other HTTP method\n    res.status(200).json({\n      users: ['Gowtham']\n    });\n  }\n});","map":null,"metadata":{},"sourceType":"module"}